
import unittest
import ROOT
import sys

from spectrum.spectrum import PtAnalyzer
from spectrum.input import Input

class TestSpectrum(unittest.TestCase):


	def setUp(self):
		# Different values in some pt-bins can be explained by limited statistics in those bins.
		#

		# Important:
		# This one should be set explicitely otherwise the test will fail
		# Because this global variable is set to Minuit2 in other tests
		ROOT.TVirtualFitter.SetDefaultFitter('Minuit')



		
		linux = [[0.13850188255310059, 0.13791368901729584, 0.13775815069675446, 0.13761039078235626, 0.1374797821044922, 0.13740836083889008, 0.13733801245689392, 0.13734140992164612, 0.13733044266700745, 0.13722273707389832, 0.13723504543304443, 0.13733528554439545, 0.137334942817688, 0.13737817108631134, 0.13735465705394745, 0.13725216686725616, 0.13729789853096008, 0.13753753900527954, 0.13744144141674042, 0.1372239589691162, 0.13753533363342285, 0.13759322464466095, 0.13749785721302032, 0.13751302659511566, 0.13813269138336182, 0.13780002295970917, 0.1366887092590332, 0.13735653460025787, 0.1384126842021942, 0.1377091258764267, 0.13813789188861847, 0.13686636090278625], [0.006827044300734997, 0.006494111381471157, 0.006134319119155407, 0.005636404734104872, 0.005412579048424959, 0.005286516156047583, 0.0050330571830272675, 0.004913054872304201, 0.004893855657428503, 0.004882749170064926, 0.004699035082012415, 0.004480034578591585, 0.004501861520111561, 0.004493230953812599, 0.004319288302212954, 0.004269483964890242, 0.004354872275143862, 0.004374242853373289, 0.004342412110418081, 0.004306994844228029, 0.004174024797976017, 0.004648503847420216, 0.004790650214999914, 0.004732783883810043, 0.004077608697116375, 0.004199947230517864, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.004000003449618816, 0.004946759901940823, 0.004000000189989805], [14.397618293762207, 25.29273223876953, 33.23427963256836, 36.96959686279297, 36.67646408081055, 33.97105407714844, 30.162748336791992, 25.794231414794922, 21.53965187072754, 17.637765884399414, 14.435836791992188, 11.857071876525879, 9.882637977600098, 8.10377311706543, 6.588637828826904, 5.643283843994141, 2.5930445194244385, 2.206894874572754, 1.2553757429122925, 1.058980941772461, 0.5721558928489685, 0.5670304894447327, 0.36637255549430847, 0.4124884307384491, 0.19386133551597595, 0.16676945984363556, 0.11745066940784454, 0.11519179493188858, 0.051584456115961075, 0.021029522642493248, 0.02027306519448757, 0.0006740110111422837], [1.0083376169204712, 1.2622606754302979, 1.562532663345337, 1.3788681030273438, 1.746329426765442, 1.8381056785583496, 1.9116533994674683, 1.669730544090271, 1.5682169198989868, 1.368722677230835, 1.5145394802093506, 1.575566053390503, 1.3206079006195068, 1.1412217617034912, 1.235540509223938, 1.0248939990997314, 0.9854839444160461, 1.150822401046753, 0.8456722497940063, 0.9279680252075195, 1.308756947517395, 1.1893106698989868, 1.0405346155166626, 1.1662431955337524, 0.8440647125244141, 0.9825625419616699, 0.7159815430641174, 0.5915196537971497, 0.556171178817749, 0.5602166652679443, 0.5128975510597229, 0.5027408003807068], [1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781], [1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814]]
		macos = [[0.13850188255310059, 0.13791368901729584, 0.13775815069675446, 0.13761039078235626, 0.1374797821044922, 0.13740836083889008, 0.13733801245689392, 0.13734140992164612, 0.13733044266700745, 0.13722273707389832, 0.13723504543304443, 0.13733528554439545, 0.137334942817688, 0.13737817108631134, 0.13735465705394745, 0.13725216686725616, 0.13729789853096008, 0.13753753900527954, 0.13744144141674042, 0.1372239589691162, 0.13753533363342285, 0.13759322464466095, 0.13749785721302032, 0.13751672208309174, 0.13815398514270782, 0.13779579102993011, 0.13668538630008698, 0.13733690977096558, 0.13841727375984192, 0.13777600228786469, 0.13823598623275757, 0.13672225177288055], [0.006827044300734997, 0.006494111381471157, 0.006134319119155407, 0.005636404734104872, 0.005412579048424959, 0.005286516156047583, 0.0050330571830272675, 0.004913054872304201, 0.004893855657428503, 0.004882749170064926, 0.004699035082012415, 0.004480034578591585, 0.004501861520111561, 0.004493230953812599, 0.004319288302212954, 0.004269483964890242, 0.004354872275143862, 0.004374242853373289, 0.004342412110418081, 0.004306994844228029, 0.004174024797976017, 0.004648503847420216, 0.004790650214999914, 0.00471684243530035, 0.0040000006556510925, 0.004177008755505085, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.0042168921791017056, 0.004000000189989805], [14.397618293762207, 25.29273223876953, 33.23427963256836, 36.96959686279297, 36.67646408081055, 33.97105407714844, 30.162748336791992, 25.794231414794922, 21.53965187072754, 17.637765884399414, 14.435836791992188, 11.857071876525879, 9.882637977600098, 8.10377311706543, 6.588637828826904, 5.643283843994141, 2.5930445194244385, 2.206894874572754, 1.2553757429122925, 1.058980941772461, 0.5721558928489685, 0.5670304894447327, 0.36637255549430847, 0.4114648103713989, 0.1972304880619049, 0.17208175361156464, 0.1359165459871292, 0.13374803960323334, 0.06509973853826523, 0.04828018322587013, 0.04947977513074875, 0.015206478536128998], [1.0083376169204712, 1.2622606754302979, 1.562532663345337, 1.3788681030273438, 1.746329426765442, 1.8381056785583496, 1.9116533994674683, 1.669730544090271, 1.5682169198989868, 1.368722677230835, 1.5145394802093506, 1.575566053390503, 1.3206079006195068, 1.1412217617034912, 1.235540509223938, 1.0248939990997314, 0.9854839444160461, 1.150822401046753, 0.8456722497940063, 0.9279680252075195, 1.308756947517395, 1.1893106698989868, 1.0405346155166626, 1.147997498512268, 0.8264385461807251, 0.9409478306770325, 0.7074681520462036, 0.552791178226471, 0.46071502566337585, 0.5282081365585327, 0.41551369428634644, 0.5025198459625244], [1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781], [1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814]]
		self.nominal = macos if 'darwin' in sys.platform else linux


	# @unittest.skip("WARNING: This is an important test. It is skipped. Update the parameters")
	def testPi0SpectrumLHC16(self):

		# These are values calculated by standard algorithm.
		# Make sure that you have the same copy of LHC16.root file. 
		# sha 256 sum: a340256c4138894412ea87df53e5813fd92c3f90bd0e06883a18bef49ebf4c90
		# This is to test the code after refactoring.

		# TODO: change this behaviour (remove label dependence in ptdependent)
		second = PtAnalyzer(Input('input-data/LHC16.root', 'PhysTender').read(), label = 'testsignal', mode = 'q').quantities()
		actual = [ [ h.GetBinContent(i) for i in range(1, h.GetNbinsX())] for h in second]

		for a, b, c in zip(self.nominal, actual, second):
				print 'Checking ', c.GetName()
				for aa, bb in zip(a, b): self.assertAlmostEqual(aa, bb)

		# TODO: add other number of pi0s