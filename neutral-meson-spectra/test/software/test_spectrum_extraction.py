
import unittest
import ROOT
import sys

from spectrum.spectrum import PtAnalyzer
from spectrum.input import Input

class TestSpectrum(unittest.TestCase):


	def setUp(self):
		# Different values in some pt-bins can be explained by limited statistics in those bins.
		#

		# Important:
		# This one should be set explicitely otherwise the test will fail
		# Because this global variable is set to Minuit2 in other tests
		ROOT.TVirtualFitter.SetDefaultFitter('Minuit')
		
		# TODO: negative bins !?
		linux = [[0.1385035365819931, 0.1379297524690628, 0.1377740353345871, 0.1376171112060547, 0.13748160004615784, 0.13741150498390198, 0.13734154403209686, 0.13733915984630585, 0.13732565939426422, 0.1372251659631729, 0.1372394561767578, 0.13733479380607605, 0.13733546435832977, 0.13738012313842773, 0.13735418021678925, 0.1372484415769577, 0.13729068636894226, 0.13753274083137512, 0.13743533194065094, 0.1372087448835373, 0.13751940429210663, 0.1376037895679474, 0.13750572502613068, 0.13752663135528564, 0.1381254941225052, 0.13781097531318665, 0.1366795152425766, 0.1373700648546219, 0.13841138780117035, 0.13771122694015503, 0.13830219209194183, 0.13682211935520172], [0.006829891353845596, 0.00648513762280345, 0.0061491564847528934, 0.005654092878103256, 0.0054403431713581085, 0.005305469036102295, 0.00503291143104434, 0.0049264440312981606, 0.004919453989714384, 0.0048954663798213005, 0.004712176974862814, 0.0045048245228827, 0.00451483391225338, 0.004503644537180662, 0.004350554198026657, 0.004293032921850681, 0.004397036507725716, 0.00440073199570179, 0.004360508639365435, 0.0043545858934521675, 0.004232915583997965, 0.004635291174054146, 0.0047595808282494545, 0.004636007826775312, 0.004053359851241112, 0.0042190407402813435, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.004037226550281048, 0.005423584952950478, 0.0040000006556510925], [-21292.8125, -19243.90625, -12712.2978515625, -7308.19384765625, -1468.0296630859375, 3404.7119140625, 5576.7646484375, 6277.76220703125, 6138.958984375, 5741.876953125, 5155.97314453125, 4473.46240234375, 3917.324951171875, 3428.188232421875, 3001.55810546875, 2494.081787109375, 1179.2708740234375, 1057.240478515625, 601.4882202148438, 534.3523559570312, 328.10772705078125, 313.09588623046875, 203.2938690185547, 212.62045288085938, 105.29915618896484, 108.13375091552734, 57.645362854003906, 63.31928253173828, 26.082799911499023, 15.25755786895752, 8.368032455444336, 1.71998929977417], [0.9572145938873291, 1.185160517692566, 1.5655676126480103, 1.271836519241333, 1.5575073957443237, 1.6774957180023193, 1.7059613466262817, 1.5260553359985352, 1.4281840324401855, 1.2834032773971558, 1.3695411682128906, 1.4419063329696655, 1.3717505931854248, 1.1325606107711792, 1.1835919618606567, 0.9675224423408508, 1.0349256992340088, 1.146649718284607, 0.82023024559021, 0.9522941708564758, 1.193197250366211, 1.1683934926986694, 1.028658151626587, 1.404440999031067, 0.8370833992958069, 0.9262980222702026, 0.6871531009674072, 0.6397743821144104, 0.6954476237297058, 0.610698938369751, 0.6351824402809143, 0.5916465520858765], [1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781], [1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814]]
		macos = [[0.1385035365819931, 0.1379297524690628, 0.1377740353345871, 0.1376171112060547, 0.13748160004615784, 0.13741150498390198, 0.13734154403209686, 0.13733915984630585, 0.13732565939426422, 0.1372251659631729, 0.1372394561767578, 0.13733479380607605, 0.13733546435832977, 0.13738012313842773, 0.13735418021678925, 0.1372484415769577, 0.13729068636894226, 0.13753274083137512, 0.13743533194065094, 0.1372087448835373, 0.13751940429210663, 0.1376037895679474, 0.13750572502613068, 0.13752663135528564, 0.1381254941225052, 0.13781097531318665, 0.1366795152425766, 0.1373700648546219, 0.13841138780117035, 0.13771122694015503, 0.13830219209194183, 0.13682672381401062], [0.006829891353845596, 0.00648513762280345, 0.0061491564847528934, 0.005654092878103256, 0.0054403431713581085, 0.005305469036102295, 0.00503291143104434, 0.0049264440312981606, 0.004919453989714384, 0.0048954663798213005, 0.004712176974862814, 0.0045048245228827, 0.00451483391225338, 0.004503644537180662, 0.004350554198026657, 0.004293032921850681, 0.004397036507725716, 0.00440073199570179, 0.004360508639365435, 0.0043545858934521675, 0.004232915583997965, 0.004635291174054146, 0.0047595808282494545, 0.004636007826775312, 0.00405335845425725, 0.0042190407402813435, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.004037226550281048, 0.005423584952950478, 0.0040000006556510925], [-21292.8125, -19243.90625, -12712.2978515625, -7308.19384765625, -1468.0296630859375, 3404.7119140625, 5576.7646484375, 6277.76220703125, 6138.958984375, 5741.876953125, 5155.97314453125, 4473.46240234375, 3917.324951171875, 3428.188232421875, 3001.55810546875, 2494.081787109375, 1179.2708740234375, 1057.240478515625, 601.4882202148438, 534.3523559570312, 328.10772705078125, 313.09588623046875, 203.2938690185547, 212.62045288085938, 105.29915618896484, 108.13375091552734, 57.645362854003906, 63.31928253173828, 26.082799911499023, 15.25755786895752, 8.368032455444336, 1.71998929977417], [0.9572145938873291, 1.185160517692566, 1.5655676126480103, 1.271836519241333, 1.5575073957443237, 1.6774957180023193, 1.7059613466262817, 1.5260553359985352, 1.4281840324401855, 1.2834032773971558, 1.3695411682128906, 1.4419063329696655, 1.3717505931854248, 1.1325606107711792, 1.1835919618606567, 0.9675224423408508, 1.0349256992340088, 1.146649718284607, 0.82023024559021, 0.9522941708564758, 1.193197250366211, 1.1683934926986694, 1.028658151626587, 1.404440999031067, 0.8370832800865173, 0.9262980222702026, 0.6871531009674072, 0.6397742033004761, 0.6954476237297058, 0.6106991171836853, 0.6351824402809143, 0.5899117588996887], [1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781, 1.4930000305175781], [1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814, 1.5959999561309814]]
		self.nominal = macos if 'darwin' in sys.platform else linux


	# @unittest.skip("WARNING: This is an important test. It is skipped. Update the parameters")
	def testPi0SpectrumLHC16(self):

		# These are values calculated by standard algorithm.
		# Make sure that you have the same copy of LHC16.root file. 
		# sha 256 sum: a340256c4138894412ea87df53e5813fd92c3f90bd0e06883a18bef49ebf4c90
		# This is to test the code after refactoring.

		# TODO: change this behaviour (remove label dependence in ptdependent)
		second = PtAnalyzer(Input('input-data/LHC16.root', 'PhysTender').read(), label = 'testsignal', mode = 'q').quantities()
		actual = [ [ h.GetBinContent(i) for i in range(1, h.GetNbinsX())] for h in second]

		for a, b, c in zip(self.nominal, actual, second):
			print 'Checking ', c.GetName()
			# print b
			for aa, bb in zip(a, b): self.assertAlmostEqual(aa, bb)

		# TODO: add other number of pi0s