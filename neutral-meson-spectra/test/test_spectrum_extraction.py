
import unittest
import ROOT
import sys

from spectrum.spectrum import PtAnalyzer
from spectrum.input import Input

class TestSpectrum(unittest.TestCase):


	def setUp(self):
		# Different values in some pt-bins can be explained by limited statistics in those bins.
		# 
		# TODO update it for Mac
		linux = [[0.13886027038097382, 0.13847097754478455, 0.13832306861877441, 0.13813923299312592, 0.138043612241745, 0.13795480132102966, 0.13781391084194183, 0.13778507709503174, 0.1377449482679367, 0.13767538964748383, 0.13771694898605347, 0.13779747486114502, 0.13780418038368225, 0.13785502314567566, 0.1377766728401184, 0.137653186917305, 0.13770939409732819, 0.13796435296535492, 0.13781677186489105, 0.13759730756282806, 0.1378275454044342, 0.1379317045211792, 0.1378365010023117, 0.13793928921222687, 0.13825799524784088, 0.13813818991184235, 0.1367677003145218, 0.13738895952701569, 0.13861329853534698, 0.13786908984184265, 0.13848862051963806, 0.13861341774463654], [0.006623215973377228, 0.0064107379876077175, 0.006078921724110842, 0.005489220377057791, 0.0053513022139668465, 0.005285040941089392, 0.005008378531783819, 0.004836471751332283, 0.004812030121684074, 0.004768694750964642, 0.004654865711927414, 0.004506391938775778, 0.004441895522177219, 0.004301336593925953, 0.004056260921061039, 0.004119093995541334, 0.004248646553605795, 0.004202737472951412, 0.004098179284483194, 0.004014900885522366, 0.004000000189989805, 0.004223767202347517, 0.0041242376901209354, 0.004000000189989805, 0.004000000189989805, 0.004027289804071188, 0.004000000189989805, 0.004000000189989805, 0.004000003915280104, 0.004098992329090834, 0.005110704340040684, 0.004000000189989805], [16.14336395263672, 27.539098739624023, 36.67844772338867, 40.32383346557617, 39.9837646484375, 36.47528076171875, 32.171852111816406, 27.602014541625977, 22.864479064941406, 18.935068130493164, 15.57839298248291, 12.912925720214844, 10.574726104736328, 8.685738563537598, 7.294403553009033, 6.083954811096191, 2.7977213859558105, 2.3806943893432617, 1.3346607685089111, 1.1200169324874878, 0.6356903314590454, 0.570990800857544, 0.31588223576545715, 0.3359544277191162, 0.18550188839435577, 0.1617516428232193, 0.1228853091597557, 0.11522600054740906, 0.062490370124578476, 0.0457284115254879, 0.038219232112169266, 0.014327234588563442], [1.0686933994293213, 2.1794211864471436, 3.3411705493927, 3.5384340286254883, 5.081161022186279, 5.285619735717773, 4.597793102264404, 3.696786403656006, 3.116334915161133, 3.2523245811462402, 3.290680170059204, 3.114171266555786, 2.797290325164795, 2.369781732559204, 2.2778079509735107, 1.7081298828125, 1.5192488431930542, 1.8569408655166626, 1.1597834825515747, 1.2870761156082153, 1.8084864616394043, 1.6627215147018433, 1.4238629341125488, 1.4809530973434448, 1.04543137550354, 1.2118678092956543, 0.8942000865936279, 0.6602737307548523, 0.628696084022522, 0.9666146636009216, 0.9489657282829285, 1.4687358140945435], [14.125039100646973, 58.59923553466797, -349.7783508300781, 80.5916976928711, 39.770626068115234, 91.86044311523438, 67.6927490234375, 43.57749557495117, 97.91620635986328, 100.85832214355469, 141.28932189941406, 45.459083557128906, 64.97359466552734, 49.55099105834961, 29.721233367919922, 25.792308807373047, 26.57746124267578, 30.042024612426758, 12.974713325500488, 12.171521186828613, 8.127699851989746, 11.01314926147461, 8.363261222839355, 4.630829334259033, 4.042581558227539, 5.098428249359131, 2.930422306060791, 3.395714521408081, 2.6741325855255127, 2.349583864212036, 1.8120026588439941, 1.682373285293579]]
		macos = [[0.13848088681697845, 0.13828511536121368, 0.13823994994163513, 0.13816820085048676, 0.1382240504026413, 0.13814900815486908, 0.1380801498889923, 0.1380479484796524, 0.13782799243927002, 0.13760854303836823, 0.13801124691963196, 0.1384013593196869, 0.13820196688175201, 0.13826081156730652, 0.13810060918331146, 0.13780196011066437, 0.13759833574295044, 0.13796329498291016, 0.13750530779361725, 0.13735724985599518, 0.13720162212848663, 0.13728106021881104, 0.1377563178539276, 0.1373967081308365, 0.13748648762702942, 0.13905221223831177, 0.14127646386623383, 0.14119139313697815, 0.13834848999977112, 0.13345162570476532, 0.13865238428115845, 0.15000000596046448], [0.00611430499702692, 0.0060094427317380905, 0.005940951406955719, 0.005489265080541372, 0.005374411586672068, 0.00516161136329174, 0.004745774902403355, 0.004377311561256647, 0.0045454055070877075, 0.004509542137384415, 0.004366124048829079, 0.004323403816670179, 0.004332812502980232, 0.004140882752835751, 0.004000000189989805, 0.004000000189989805, 0.0044335476122796535, 0.004000000189989805, 0.004110755864530802, 0.004398512654006481, 0.004743511788547039, 0.0054037547670304775, 0.004000000189989805, 0.004339608829468489, 0.005153023172169924, 0.004000000189989805, 0.004000000189989805, 0.004000000189989805, 0.006504415534436703, 0.006498481146991253, 0.004000000189989805, 0.029999999329447746], [4.394284725189209, 3.8298611640930176, 4.361423015594482, 4.893136501312256, 5.013472557067871, 4.542922019958496, 3.8443098068237305, 3.19132661819458, 2.7169525623321533, 2.221317768096924, 1.9409315586090088, 1.6430128812789917, 1.3173328638076782, 1.0886865854263306, 1.0043036937713623, 0.750325620174408, 0.3564240634441376, 0.3028069734573364, 0.32731255888938904, 0.30638378858566284, 0.17437754571437836, 0.17585209012031555, 0.12969857454299927, 0.12466778606176376, 0.9056238532066345, 0.1527048945426941, 0.1123756393790245, 0.09746409207582474, 0.061474621295928955, 5.358443260192871, 0.014624787494540215, -0.017796093598008156], [149.34432983398438, 1.795995831489563, 1.9149119853973389, 1.529389500617981, 1.5132492780685425, 1.3767731189727783, 1.6967785358428955, 1.7453685998916626, 1.6737383604049683, 1.7003772258758545, 1.7994470596313477, 1.7482850551605225, 2.335381031036377, 1.8158568143844604, 2.976055383682251, 1.9956586360931396, 1.6945616006851196, 1.7280707359313965, 1.0740305185317993, 0.8503637909889221, 0.8460671901702881, 1.0788966417312622, 0.9657233953475952, 1.9507358074188232, 32.00002670288086, 7.902701377868652, 77.71343994140625, 143.03738403320312, 0.43956413865089417, 19770.291015625, 0.26231423020362854, 10.68407154083252], [4.819395542144775, 4.228025913238525, 11.726775169372559, 19.222726821899414, 12.23419189453125, 12.047880172729492, 10.329257011413574, 10.26630973815918, 10.826713562011719, 10.861712455749512, 11.052289962768555, 11.74361801147461, 9.550834655761719, 9.094244956970215, 5.439443588256836, 5.200047492980957, 6.941402435302734, 5.855371475219727, 6.314956188201904, 5.322268486022949, 3.806645393371582, 3.9224541187286377, 2.506462335586548, 2.26739239692688, 1.1858528852462769, 1.5387414693832397, 1.561975359916687, 1.8225845098495483, 2.146925926208496, 1.0201036930084229, 1.8055775165557861, 0.29267171025276184]]
		self.nominal = macos if 'darwin' in sys.platform else linux


	def testPi0SpectrumLHC16(self):
		# These are values calculated by standard algorithm.
		# Make sure that you have the same copy of LHC16.root file. 
		# sha 256 sum: a340256c4138894412ea87df53e5813fd92c3f90bd0e06883a18bef49ebf4c90
		# This is to test the code after refactoring.

		second = PtAnalyzer(Input('input-data/LHC16.root', 'PhysTender').read(), label = 'Mixing', mode = 'q').quantities()
		actual = [ [ h.GetBinContent(i) for i in range(1, h.GetNbinsX())] for h in second]

		for a, b, c in zip(self.nominal, actual, second):
				print 'Checking ', c.GetName()
				for aa, bb in zip(a, b): self.assertAlmostEqual(aa, bb)